<div class="container mt-5" *ngIf="produit">
  <div class="row">
    <div class="col-md-6">
      <div class="main-image shadow-sm mb-3 text-center bg-light p-4 rounded">
        <img [src]="produit.images[0]" class="img-fluid rounded" style="max-height: 400px;" alt="{{produit.title}}">
      </div>
      <div class="d-flex gap-2 overflow-auto">
        @for (img of produit.images; track $index) {
        <img [src]="img" class="img-thumbnail" style="width: 80px; height: 80px; cursor: pointer;">
        }
      </div>
    </div>

    <div class="col-md-6">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/">Accueil</a></li>
          <li class="breadcrumb-item active">{{produit.category}}</li>
        </ol>
      </nav>

      <h1 class="display-5 fw-bold">{{produit.title}}</h1>
      <p class="text-muted fs-5">{{produit.brand}}</p>

      <div class="d-flex align-items-center mb-3">
        <span class="badge bg-warning text-dark me-2">⭐ {{ (averageRating$ | async | number:'1.1-2') || produit.rating
          }}</span>
        <span class="text-muted small">({{ (reviews$ | async)?.length || 0 }} avis clients)</span>
      </div>

      <h2 class="text-primary mb-4 fw-bold">{{produit.price | currency : currencyService.selectedCurrency()}}</h2>

      <p class="lead">{{produit.description}}</p>

      <div class="mt-4 p-3 bg-light rounded border">
        <p><strong>Disponibilité :</strong>
          <span [class.text-success]="produit.stock > 0" [class.text-danger]="produit.stock <= 0">
            {{ produit.stock > 0 ? 'En stock (' + produit.stock + ')' : 'Rupture de stock' }}
          </span>
        </p>
        <button class="btn btn-primary btn-lg w-100" [disabled]="produit.stock <= 0"
          (click)="addProduitToCart(produit)">
          <i class="bi bi-cart-plus"></i> Ajouter au panier
        </button>
      </div>
    </div>
  </div>

  <hr class="my-5">

  <div class="row mt-5">
    <div class="col-12">
      <h3 class="mb-4">Avis des clients</h3>

      <div *ngIf="user$ | async as user; else loginMsg" class="mb-5 p-4 border rounded bg-light shadow-sm">
        <h5>Laissez un avis</h5>

        <div *ngIf="showSuccessMsg" class="alert alert-success alert-dismissible fade show" role="alert">
          <strong>Succès !</strong> Votre avis a été ajouté.
        </div>

        <div class="mb-3">
          <label class="form-label d-block fw-bold">Votre note :</label>
          <div class="d-flex gap-2">
            @for (star of stars; track star) {
            <i class="bi fs-3 cursor-pointer" [class.bi-star-fill]="star <= selectedRating"
              [class.bi-star]="star > selectedRating" [class.text-warning]="star <= selectedRating"
              [class.text-muted]="star > selectedRating" style="cursor: pointer;" (click)="setRating(star)">
            </i>
            }
          </div>
        </div>

        <textarea #commentInput class="form-control mb-3" rows="3" placeholder="Votre commentaire..."></textarea>
        <button (click)="postComment(commentInput, selectedRating)" class="btn btn-primary px-4">Envoyer</button>
      </div>

      <ng-template #loginMsg>
        <div class="alert alert-info shadow-sm">
          <i class="bi bi-info-circle me-2"></i> Veuillez vous <a routerLink="/auth" class="alert-link">connecter</a>
          pour laisser un avis.
        </div>
      </ng-template>

      <div *ngIf="reviews$ | async as reviews" class="mb-5">

        <div *ngIf="reviews.length === 0" class="alert alert-warning">
          Aucun avis pour le moment. Soyez le premier !
        </div>

        <div *ngFor="let review of reviews" class="card mb-3 border-0 shadow-sm review-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="card-title mb-0 fw-bold">{{ review.reviewerName }}</h6>
              <small class="text-muted">
                <!-- Gestion date: compatible String (DummyJSON) et Timestamp/Date (Firebase) -->
                {{ review.date?.toDate ? (review.date.toDate() | date:'mediumDate') : (review.date | date:'mediumDate')
                }}
              </small>
            </div>
            <div class="mb-2">
              <!-- Etoiles simplifiées -->
              <span class="text-warning">
                {{ '★'.repeat(review.rating || 5) }}<span class="text-muted">{{ '☆'.repeat(5 - (review.rating || 5))
                  }}</span>
              </span>
            </div>
            <p class="card-text text-secondary">"{{ review.comment }}"</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>